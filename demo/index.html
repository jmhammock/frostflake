<!DOCTYPE html>
<html>
    <head>
        <title>FrostFlake Demo</title>
    </head>
    <body>
        <canvas id="frostFlake" width="640" height="480"></canvas>

        <!-- DEV: include all files -->
        <script type='text/javascript' src='/src/GameTime.js'></script>
        <script type='text/javascript' src='/src/Utility/MathUtil.js'></script>
        <script type='text/javascript' src='/src/Entities/Sprite.js'></script>
        <script type='text/javascript' src='/src/Entities/Camera.js'></script>
        <script type='text/javascript' src='/src/Drawing/CanvasRenderer.js'></script>
        <script type='text/javascript' src='/src/Drawing/Frame.js'></script>
        <script type='text/javascript' src='/src/Drawing/Animation.js'></script>
        <script type='text/javascript' src='/src/Shapes/Shape.js'></script>
        <script type='text/javascript' src='/src/Shapes/Circle.js'></script>
        <script type='text/javascript' src='/src/Views/View.js'></script>
        <script type='text/javascript' src='/src/Logging/Log.js'></script>
        <script type='text/javascript' src='/src/Input/Cursor.js'></script>
        <script type='text/javascript' src='/src/Input/Keys.js'></script>
        <script type='text/javascript' src='/src/Input/Mouse.js'></script>
        <script type='text/javascript' src='/src/Input/Input.js'></script>
        <script type='text/javascript' src='/src/FrostFlake.js'></script>

        <!-- PROD: include built file-->
        <!-- <script type="text/javascript" src="/build/frostflake.concat.js"></script> -->

        <script>

        // get a reference to the canvas element
        let canvas = document.getElementById('frostFlake');

        // initialize frostflake with a reference to the canvas
        // and a target framerate
        let ff = new FrostFlake(canvas, 60);

        // turn debug visualizations on or off
        ff.showDebug = false;

        // start running the game
        ff.start();

        // Each of the following demo classes shows how
        // to use basic engine features. Load one of these
        // demo classes by typing the following command
        // in your browser's JavaScript console:
        // ff.view = new DemoClassName();
        class ManySpriteDemo extends View {
            constructor() {
                super();

                for (var i = 0; i < 2000; i++) {
                    var s = new Sprite('Content/frostflake.png');
                    s.x = MathUtil.randomInRange(-300, 300);
                    s.y = MathUtil.randomInRange(-200, 200);
                    s.alpha = MathUtil.randomInRange(0.2, 0.85);
                    s.rotationVelocity = MathUtil.randomInRange(-3, 3);
                    this.addSprite(s);
                }
            }
        }

        class ParentChildDemo extends View {
            parentFlake;
            childFlake1;
            childFlake2;

            constructor() {
                super();

                // create a parent sprite and add it to the View sprites
                this.parentFlake = new Sprite('Content/frostflake.png');
                this.parentFlake.rotationVelocity = 3;
                this.addSprite(this.parentFlake);

                // create and attach a child sprite
                this.childFlake1 = new Sprite('Content/frostflake.png');
                this.childFlake1.x = -40;
                this.childFlake1.rotationVelocity = -5;
                this.parentFlake.addChild(this.childFlake1);

                // create and attach a child sprite
                this.childFlake2 = new Sprite('Content/frostflake.png');
                this.childFlake2.x = 40;
                this.childFlake2.rotationVelocity = 5;
                this.parentFlake.addChild(this.childFlake2);
            }
        }

        class InputDemo extends View {

            cursorSprite;

            constructor() {
                super();

                // create some sprites so camera movement is visible
                for (var i = 0; i < 10; i++) {
                    var s = new Sprite('Content/frostflake.png');
                    s.x = MathUtil.randomInRange(-300, 300);
                    s.y = MathUtil.randomInRange(-200, 200);
                    s.alpha = MathUtil.randomInRange(0.2, 0.85);
                    s.rotationVelocity = MathUtil.randomInRange(-3, 3);
                    this.addSprite(s);
                }

                // create a sprite based on part of a sprite sheet and add it to the View
                this.cursorSprite = new Sprite('Content/spritesheet.png');
                this.cursorSprite.frame = new Frame(32, 0, 32, 32);
                this.addSprite(this.cursorSprite);
            }

            update() {
                super.update();

                // shortcuts
                let input = FrostFlake.Game.input;
                let cursor = input.cursor;
                let cam = FrostFlake.Game.camera;

                // make cursorSprite follow hardware cursor
                this.cursorSprite.x = cursor.worldX;
                this.cursorSprite.y = cursor.worldY;

                // make cursor rotate when clicked
                if (input.buttonDown(Mouse.Left)) {
                    this.cursorSprite.rotationVelocity = -5;
                }
                else {
                    this.cursorSprite.rotationVelocity = 0;
                }

                // move the camera when WASD pushed
                if (input.keyPushed(Keys.W)) {
                    cam.y += 100;
                }
                if (input.keyPushed(Keys.S)) {
                    cam.y -= 100;
                }
                if (input.keyPushed(Keys.A)) {
                    cam.x -= 100;
                }
                if (input.keyPushed(Keys.D)) {
                    cam.x += 100;
                }
            }
        }

        class AnimationDemo extends View {
            runCycle;
            sprite;

            constructor() {
                super();

                // create an animation with three, one-second frames
                this.runCycle = new Animation();
                this.runCycle.texture = 'Content/spritesheet.png';
                this.runCycle.frames = [];

                // use a loop to add 8 frames in a row from the spritesheet
                for(let i = 0; i < 8; i++) {
                    this.runCycle.frames.push(new Frame(i * 16, 160, 16, 16, 0.1));
                }

                // create a sprite and set the animation
                // the sprite is really small so turn up its scale
                this.sprite = new Sprite();
                this.sprite.scale = 3;
                this.sprite.animation = this.runCycle;

                this.addSprite(this.sprite);
            }
        }

        class CollisionDemo extends View {

            constructor() {
                super();

                let view = this;

                for (let i = 0; i < 75; i++) {
                    let s = new Sprite('Content/frostflake.png');

                    // override custom function to make sprites always bounce
                    // towards the center of the screen
                    s.customUpdate = function () {
                        let cam = FrostFlake.Game.camera;
                        if (s.x > cam.right ||
                            s.x < cam.left ||
                            s.y > cam.top ||
                            s.y < cam.bottom) {

                            let angleToCenter = MathUtil.angleTo(s, cam);
                            let speed = MathUtil.length(s.velocityX, s.velocityY);
                            s.velocityX = Math.cos(angleToCenter) * speed;
                            s.velocityY = Math.sin(angleToCenter) * speed;

                            // s.x = MathUtil.clamp(s.x, cam.left, cam.right);
                            // s.y = MathUtil.clamp(s.y, cam.bottom, cam.top);
                            // let newVel = view.getRandomBounceVelocity(s);
                            // s.velocityX = newVel.x;
                            // s.velocityY = newVel.y;
                        }
                    }

                    // give the sprites some random starting positions and velocities
                    s.x = MathUtil.randomInRange(-300, 300);
                    s.y = MathUtil.randomInRange(-200, 200);
                    s.velocityX = MathUtil.randomInRange(-500, 500);
                    s.velocityY = MathUtil.randomInRange(-500, 500);
                    s.drag = 0.25;
                    s.rotationVelocity = MathUtil.randomInRange(-2, 2);

                    this.addSprite(s);
                }
            }

            update() {
                super.update();

                // collide all sprites with all other sprites
                for (let i = this.sprites.length - 1; i > -1; i--) {
                    let s1 = this.sprites[i];

                    for (let j = this.sprites.length - 1; j > -1; j--) {
                        let s2 = this.sprites[j];

                        if (s1 == s2) {
                            continue;
                        }

                        if (s1.collision.collidesWith(s2.collision, true)) {

                            // get random bounce directions
                            let newVel1 = this.getRandomBounceVelocity(s1);
                            let newVel2 = this.getRandomBounceVelocity(s2);

                            s1.velocityX = newVel1.x
                            s1.velocityY = newVel1.y;
                            s2.velocityX = newVel2.x;
                            s2.velocityY = newVel2.y;
                        }
                    }
                }
            }

            getRandomBounceVelocity(sprite, energyLossOnBounce = 0) {
                let fortyFiveDegrees = Math.PI / 4;
                let velocityAngle = Math.atan2(sprite.velocityY, sprite.velocityX);
                let reverseAngle = MathUtil.normalizeAngle(velocityAngle - Math.PI);
                let magnitude = MathUtil.length(sprite.velocityX, sprite.velocityY) * (1 - energyLossOnBounce);
                let newAngle = reverseAngle + MathUtil.randomInRange(-fortyFiveDegrees, fortyFiveDegrees);
                let velX = Math.cos(newAngle) * magnitude;
                let velY = Math.sin(newAngle) * magnitude;
                return { x: velX, y: velY };
            }
        }

    </script>
</body>

</html>