<!DOCTYPE html>
<html>
    <head>
        <title>FrostFlake Demo</title>
    </head>
    <body>
        <canvas id="frostFlake" width="640" height="480"></canvas>

        <!-- Include FrostFlake files -->
        <script type="text/javascript" src="/build/FrostFlake.min.js"></script>

        <!-- Demo -->
        <script>

            class ManySpriteDemo extends View {
                constructor() {
                    super();

                    for(var i = 0; i < 2000; i++) {
                        var s = new Sprite('/demo/Content/frostflake.png');
                        s.x = MathUtil.randomInRange(-300, 300);
                        s.y = MathUtil.randomInRange(-200,200);
                        s.alpha = MathUtil.randomInRange(0.2, 0.85);
                        s.rotationVelocity = MathUtil.randomInRange(-3, 3);
                        this.addSprite(s);
                    }
                }
            }

<head>
    <title>FrostFlake Demo</title>
</head>

<body>
    <canvas id="frostFlake" width="640" height="480"></canvas>

    <!-- Include FrostFlake files -->
    <script type="text/javascript" src="../src/GameTime.js"></script>
    <script type="text/javascript" src="../src/Utility/MathUtil.js"></script>
    <script type="text/javascript" src="../src/Entities/Sprite.js"></script>
    <script type="text/javascript" src="../src/Entities/Camera.js"></script>
    <script type="text/javascript" src="../src/Drawing/CanvasRenderer.js"></script>
    <script type="text/javascript" src="../src/Drawing/Frame.js"></script>
    <script type="text/javascript" src="../src/Drawing/Animation.js"></script>
    <script type="text/javascript" src="../src/Shapes/Shape.js"></script>
    <script type="text/javascript" src="../src/Shapes/Circle.js"></script>
    <script type="text/javascript" src="../src/Views/View.js"></script>
    <script type="text/javascript" src="../src/Logging/Log.js"></script>
    <script type="text/javascript" src="../src/Input/Cursor.js"></script>
    <script type="text/javascript" src="../src/Input/Keys.js"></script>
    <script type="text/javascript" src="../src/Input/Mouse.js"></script>
    <script type="text/javascript" src="../src/Input/Input.js"></script>
    <script type="text/javascript" src="../src/FrostFlake.js"></script>

    <!-- Demo -->
    <script>

        class ManySpriteDemo extends View {
            constructor() {
                super();

                for (var i = 0; i < 2000; i++) {
                    var s = new Sprite('Content/frostflake.png');
                    s.x = MathUtil.randomInRange(-300, 300);
                    s.y = MathUtil.randomInRange(-200, 200);
                    s.alpha = MathUtil.randomInRange(0.2, 0.85);
                    s.rotationVelocity = MathUtil.randomInRange(-3, 3);
                    this.addSprite(s);
                }
            }
        }

        class ParentChildDemo extends View {
            parentFlake;
            childFlake1;
            childFlake2;

            constructor() {
                super();

                // create a parent sprite and add it to the View sprites
                this.parentFlake = new Sprite('Content/frostflake.png');
                this.parentFlake.rotationVelocity = 3;
                this.addSprite(this.parentFlake);

                // create and attach a child sprite
                this.childFlake1 = new Sprite('Content/frostflake.png');
                this.childFlake1.x = -40;
                this.childFlake1.rotationVelocity = -5;
                this.parentFlake.addChild(this.childFlake1);

                // create and attach a child sprite
                this.childFlake2 = new Sprite('Content/frostflake.png');
                this.childFlake2.x = 40;
                this.childFlake2.rotationVelocity = 5;
                this.parentFlake.addChild(this.childFlake2);
            }
        }

        class InputDemo extends View {

            cursorSprite;

            constructor() {
                super();

                // create some sprites so camera movement is visible
                for (var i = 0; i < 10; i++) {
                    var s = new Sprite('Content/frostflake.png');
                    s.x = MathUtil.randomInRange(-300, 300);
                    s.y = MathUtil.randomInRange(-200, 200);
                    s.alpha = MathUtil.randomInRange(0.2, 0.85);
                    s.rotationVelocity = MathUtil.randomInRange(-3, 3);
                    this.addSprite(s);
                }

                // create a sprite based on part of a sprite sheet and add it to the View
                this.cursorSprite = new Sprite('/demo/Content/spritesheet.png');
                this.cursorSprite.frame = new Frame(32, 0, 32, 32);
                this.addSprite(this.cursorSprite);
            }

            update() {
                super.update();

                // shortcuts
                let input = FrostFlake.Game.input;
                let cursor = input.cursor;
                let cam = FrostFlake.Game.camera;

                // make cursorSprite follow hardware cursor
                this.cursorSprite.x = cursor.worldX;
                this.cursorSprite.y = cursor.worldY;

                // make cursor rotate when clicked
                if (input.buttonDown(Mouse.Left)) {
                    this.cursorSprite.rotationVelocity = -5;
                }
                else {
                    this.cursorSprite.rotationVelocity = 0;
                }

                // move the camera when WASD pushed
                if (input.keyPushed(Keys.W)) {
                    cam.y += 100;
                }
                if (input.keyPushed(Keys.S)) {
                    cam.y -= 100;
                }
                if (input.keyPushed(Keys.A)) {
                    cam.x -= 100;
                }
                if (input.keyPushed(Keys.D)) {
                    cam.x += 100;
                }
            }
        }

        class AnimationDemo extends View {
            animation;
            sprite;

            constructor() {
                super();

                // create an animation with three, one-second frames
                this.animation = new Animation();
                this.animation.frames = [
                    new Frame(0, 0, 32, 32, 1),
                    new Frame(32, 0, 32, 32, 1),
                    new Frame(64, 0, 32, 32, 1)
                ];
                this.animation.texture = '/demo/Content/spritesheet.png';

                // create a sprite and set the animation
                this.sprite = new Sprite();
                this.sprite.animation = this.animation;
                this.sprite.rotationVelocity = MathUtil.randomInRange(-3, 3);

                this.addSprite(this.sprite);
            }
        }

        class CollisionDemo extends View {

            constructor() {
                super();

                let view = this;

                for (let i = 0; i < 75; i++) {
                    let s = new Sprite('Content/frostflake.png');

                    // override custom function to make sprites always bounce
                    // towards the center of the screen
                    s.customUpdate = function () {
                        let cam = FrostFlake.Game.camera;
                        if (s.x > cam.right ||
                            s.x < cam.left ||
                            s.y > cam.top ||
                            s.y < cam.bottom) {

                            let angleToCenter = MathUtil.angleTo(s, cam);
                            let speed = MathUtil.length(s.velocityX, s.velocityY);
                            s.velocityX = Math.cos(angleToCenter) * speed;
                            s.velocityY = Math.sin(angleToCenter) * speed;

                            // s.x = MathUtil.clamp(s.x, cam.left, cam.right);
                            // s.y = MathUtil.clamp(s.y, cam.bottom, cam.top);
                            // let newVel = view.getRandomBounceVelocity(s);
                            // s.velocityX = newVel.x;
                            // s.velocityY = newVel.y;
                        }
                    }

                    // give the sprites some random starting positions and velocities
                    s.x = MathUtil.randomInRange(-300, 300);
                    s.y = MathUtil.randomInRange(-200, 200);
                    s.velocityX = MathUtil.randomInRange(-500, 500);
                    s.velocityY = MathUtil.randomInRange(-500, 500);
                    s.drag = 0.25;
                    s.rotationVelocity = MathUtil.randomInRange(-2, 2);

                    this.addSprite(s);
                }
            }

            update() {
                super.update();

                // collide all sprites with all other sprites
                for (let i = this.sprites.length - 1; i > -1; i--) {
                    let s1 = this.sprites[i];

                    for (let j = this.sprites.length - 1; j > -1; j--) {
                        let s2 = this.sprites[j];

                        if (s1 == s2) {
                            continue;
                        }

                        if (s1.collision.collidesWith(s2.collision, true)) {

                            // get random bounce directions
                            let newVel1 = this.getRandomBounceVelocity(s1);
                            let newVel2 = this.getRandomBounceVelocity(s2);

                            s1.velocityX = newVel1.x
                            s1.velocityY = newVel1.y;
                            s2.velocityX = newVel2.x;
                            s2.velocityY = newVel2.y;
                        }
                    }
                }
            }

            getRandomBounceVelocity(sprite, energyLossOnBounce = 0) {
                let fortyFiveDegrees = Math.PI / 4;
                let velocityAngle = Math.atan2(sprite.velocityY, sprite.velocityX);
                let reverseAngle = MathUtil.normalizeAngle(velocityAngle - Math.PI);
                let magnitude = MathUtil.length(sprite.velocityX, sprite.velocityY) * (1 - energyLossOnBounce);
                let newAngle = reverseAngle + MathUtil.randomInRange(-fortyFiveDegrees, fortyFiveDegrees);
                let velX = Math.cos(newAngle) * magnitude;
                let velY = Math.sin(newAngle) * magnitude;
                return { x: velX, y: velY };
            }
        }

        let canvas = document.getElementById('frostFlake');

        let ff = new FrostFlake(canvas, 60);
        ff.showDebug = false;
        ff.start();
    </script>
</body>

</html>